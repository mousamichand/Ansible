---
- name: Raise Change Request and wait for approval
  hosts: all
  gather_facts: no
  vars:
    servicenow_instance: "{{ lookup('cypher','secret=secret/snowinstance')}}"
    servicenow_user: "er.mousamichand@gmail.com"
    servicenow_password: "{{ lookup('cypher','secret=secret/snowpass') | password_hash('sha512') }}"
    change_request_payload:
      short_description: "Update Apache server"
      description: "Updating Apache server to latest stable version"
      category: "Software"
      priority: "3"
      risk: "Low"
      type: "Normal"
  tasks:
    - name: Create a Change Request in ServiceNow
      uri:
        url: "https://{{ servicenow_instance }}/api/now/table/change_request"
        method: POST
        user: "{{ servicenow_user }}"
        password: "{{ servicenow_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body: "{{ change_request_payload }}"
        status_code: 201
      register: create_response

    - name: Extract sys_id of created Change Request
      set_fact:
        change_request_sys_id: "{{ create_response.json.result.sys_id }}"

    - name: Wait for Change Request approval
      vars:
        approval_status: ""
      block:
        - name: Check approval status
          uri:
            url: "https://{{ servicenow_instance }}/api/now/table/change_request?sys_id={{ change_request_sys_id }}"
            method: GET
            user: "{{ servicenow_user }}"
            password: "{{ servicenow_password }}"
            force_basic_auth: yes
            headers:
              Accept: "application/json"
          register: query_response
          until: query_response.json.result[0].approval == "approved"
          retries: 20          # number of polling attempts
          delay: 30            # seconds between polls
          ignore_errors: yes

        - name: Fail if Change Request is not approved after retries
          fail:
            msg: "Change Request was not approved within the expected time."
          when: query_response.json.result[0].approval != "approved"

    - name: Show approved message
      debug:
        msg: "Change Request {{ change_request_sys_id }} is approved!"
