---
- name: Raise Change Request and wait for approval
  hosts: all
  gather_facts: no
  vars:
    servicenow_instance: "{{ lookup('cypher','secret=secret/snowinstance')}}"
    servicenow_user: "er.mousamichand@gmail.com"
    servicenow_password: "{{ lookup('cypher','secret=secret/snowpass') | password_hash('sha512') }}"
    change_request_payload:
      short_description: "Update Apache server"
      description: "Updating Apache server to latest stable version"
      category: "Software"
      priority: "3"
      risk: "Low"
      type: "Normal"
  tasks:
    - name: Create a Change Request in ServiceNow
      uri:
        url: "https://{{ servicenow_instance }}/api/now/table/change_request"
        method: POST
        user: "{{ servicenow_user }}"
        password: "{{ servicenow_password }}"
        force_basic_auth: yes
        headers:
          Content-Type: "application/json"
          Accept: "application/json"
        body_format: json
        body: "{{ change_request_payload }}"
        status_code: 201
      register: create_response

    - name: Display the created Change Request sys_id
      debug:
        msg: "Change Request created with sys_id: {{ result.json.result.sys_id }}"
